# 🎨 Softpal PGD Toolkit

** PNG ⇔ PGD 图像格式互转工具**

用于转换 Softpal 游戏引擎的 PGD 格式图像，支持批量处理和多种优化模式。

## 📦 支持格式

### GE 系列格式

| 类型 | 说明 | 压缩特性 |
|------|------|----------|
| **GE 类型 1** | BGR 平面分离压缩 | 无损 LZ 压缩 |
| **GE 类型 2** | YUV 色彩空间编码 | 色度下采样，不支持透明 |
| **GE 类型 3** | 行预测差分压缩 | 高压缩率，支持透明 |

### Others 系列格式

| 类型 | 说明 | 应用场景 |
|------|------|----------|
| **00_C** | 标准压缩格式 | 通用场景 |
| **11_C** | 优化压缩格式 | 高质量要求 |
| **TGA** | TGA 兼容格式 | 兼容性需求 |
| **PGD3** | 增量叠加格式 | 差分存储，需要基准图 |

> **💡 提示**：PGD3 是增量格式，需要指定基准 PGD/GE 图片进行生成和解码。

---

## 🚀 快速开始

### Windows 快捷方式

```batch
# 1. 安装依赖
双击运行 "安装依赖.bat"

# 2. 启动图形界面
双击运行 "启动GUI.bat"

---

## 📥 安装说明

### 依赖安装

#### 必需依赖

```bash
pip install numpy>=1.21.0
pip install opencv-python>=4.5.0
pip install pillow>=8.3.0
pip install xxhash>=2.0.0
```

#### 可选依赖

```bash
# 进度条支持
pip install tqdm>=4.62.0

# CPU 加速（强烈推荐）
pip install numba>=0.55.0

# GUI 支持
pip install customtkinter>=4.6.0
pip install tkinterdnd2>=0.3.0
```

#### GPU 加速依赖

根据您的 CUDA 版本选择：

```bash
# CUDA 11.x
pip install cupy-cuda11x>=11.0.0

# CUDA 12.x（推荐）
pip install cupy-cuda12x>=12.0.0
```

> **💡 提示**：运行 `安装依赖.bat` 可自动安装所有依赖（CUDA 12.x 版本）。

---

## 📖 使用指南

### 图形界面模式

#### 1. 启动界面

```bash
python main_UI.py
```

或双击 `启动GUI.bat`

#### 2. 基本操作流程

1. **选择转换模式**：PGD → PNG 或 PNG → PGD
2. **选择 PGD 类型**：推荐使用「自动」检测
3. **配置压缩设置**：
   - 压缩类型：1/2/3（仅 GE 格式）
   - 压缩预设：fast / normal / max
4. **优化选项**：
   - 质量级别：1 (fast) / 2 (balanced) / 3 (best)
   - GPU 加速：勾选启用（需要 CuPy）
5. **选择文件**：
   - 点击「📄 文件」选择单个文件
   - 点击「📁 文件夹」选择文件夹批量处理
   - 或直接拖放文件/文件夹到输入框
6. **指定输出路径**（可选）：留空则输出到同目录
7. **高级选项**（可选）：
   - 模板 PGD：继承元数据信息
   - 基准 PGD：用于 PGD3 格式
8. **开始处理**：点击「开始处理」按钮

#### 3. 界面功能说明

- **🌙/🌞 主题切换**：右上角按钮切换深色/浅色主题
- **📂 递归处理**：勾选后将处理子文件夹中的所有文件
- **暂停/继续**：处理过程中可随时暂停或继续
- **停止处理**：立即终止当前任务
- **清空日志**：清除日志输出区域内容


### 核心模块说明

#### 格式转换模块

- **pgd2png_ge.py**：GE 系列格式解码（类型 1/2/3）
- **pgd2png_others.py**：Others 系列解码（00_C、11_C、TGA、PGD3）
- **png2pgd_ge.py**：GE 系列格式编码，支持模板和优化
- **png2pgd_others.py**：Others 系列编码，支持增量格式

#### 性能优化模块

- **pgd_optimizer.py**：
  - 阶段1：FastMatcher 优化、SIMD 向量化、内存池
  - 阶段2：自适应 Y 修正、边缘感知滤波
  - 阶段3：动态规划、多基准选择、代价模型
- **pgd_gpu_accelerator.py**：
  - CUDA YUV 转换加速
  - 多 GPU 协同支持
- **parallel_processor.py**：
  - 线程池并行处理
  - 进度聚合与节流
  - 任务控制（暂停/停止）

---

## ✨ 功能特性

### 🚀 核心功能

- **双向转换**：支持 PNG ⇔ PGD 格式双向转换
- **自动识别**：智能检测 PGD 文件类型，无需手动指定
- **批量处理**：支持文件夹批量转换，自动递归子目录
- **模板继承**：从原始 PGD 文件继承位置、表演等元数据信息
- **增量格式**：支持 PGD3 增量叠加格式，自动查找基准图像

### 🎨 现代化界面

- **CustomTkinter**：基于 CustomTkinter 的现代化 UI 设计
- **深色/浅色主题**：支持主题切换，保护视力
- **拖放支持**：拖拽文件/文件夹即可开始处理
- **实时进度**：显示处理进度、速度和预计剩余时间
- **日志输出**：实时查看处理日志和错误信息

---

## ❓ 常见问题

### 功能说明

**Q1：什么是「模板 PGD」？**

A：模板 PGD 是从游戏中提取的原始 PGD 文件，包含位置、表演等元数据信息。指定模板后，生成的 PGD 文件会继承这些信息，确保与游戏兼容。

**Q2：什么是「基准 PGD」？**

A：基准 PGD 用于 PGD3 增量格式。PGD3 只存储与基准图像的差异，需要基准图像才能正确生成和解码。勾选「根据模版自动查找基准」时，程序会从模板 PGD 中读取基准图像名称，并在同目录自动查找。

**Q3：「自动类型」如何工作？**

A：
- **PGD → PNG**：自动读取文件头识别 PGD 类型（GE 1/2/3、00_C、11_C、TGA、PGD3）
- **PNG → PGD**：从「模板 PGD」自动识别需要生成的类型，无需手动选择



